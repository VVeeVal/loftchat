generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified Boolean?
  image         String?
  bio           String?   // User bio
  isAdmin       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  accounts      Account[]

  // App specific
  createdChannels Channel[]
  memberships     ChannelMember[]
  messages        Message[]
  dmParticipants  DMParticipant[]
  dmMessages      DMMessage[] @relation("Sender")
  registrationLinks RegistrationLink[]
  organizationMemberships OrganizationMember[]

  // Reactions and mentions
  reactions     Reaction[]
  dmReactions   DMReaction[]
  mentions      Mention[]
  dmMentions    DMMention[]
  uploads       Upload[]
  bookmarks     Bookmark[]

  @@map("user")
}

model Session {
  id                    String   @id
  userId                String
  token                 String   @unique
  expiresAt             DateTime
  ipAddress             String?
  userAgent             String?
  activeOrganizationId  String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganization    Organization? @relation(fields: [activeOrganizationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([activeOrganizationId])
  @@map("session")
}

model Account {
  id           String    @id
  userId       String
  accountId    String
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  password     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

// --- Application Models ---

model Organization {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members             OrganizationMember[]
  channels            Channel[]
  dmSessions          DMSession[]
  registrationLinks   RegistrationLink[]
  sessions            Session[]
  uploads             Upload[]
  customEmojis        CustomEmoji[]

  @@map("organization")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           String   @default("MEMBER") // ADMIN or MEMBER
  joinedAt       DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_member")
}

model Channel {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  isPrivate      Boolean  @default(false)
  isArchived     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  createdBy      String
  creator        User     @relation(fields: [createdBy], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  members        ChannelMember[]
  messages       Message[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model ChannelMember {
  id        String   @id @default(cuid())
  channelId String
  userId    String
  role      String   @default("MEMBER") // ADMIN, MEMBER
  joinedAt  DateTime @default(now())
  lastReadAt DateTime @default(now()) // New: Unread tracking
  notificationPreference NotificationPreference @default(ALL)
  
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isStarred Boolean  @default(false)

  @@unique([channelId, userId])
}

model Message {
  id        String   @id @default(cuid())
  content   String
  channelId String
  senderId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isEdited  Boolean  @default(false)
  isPinned  Boolean  @default(false)

  // Threading
  threadId    String?
  parent      Message?  @relation("Thread", fields: [threadId], references: [id])
  replies     Message[] @relation("Thread")
  replyCount  Int       @default(0)

  channel     Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender      User      @relation(fields: [senderId], references: [id])

  // Reactions and mentions
  reactions   Reaction[]
  mentions    Mention[]
  attachments Attachment[]
  bookmarks   Bookmark[]

  @@index([channelId, createdAt])
  @@index([threadId])
}

model DMSession {
  id             String          @id @default(cuid())
  organizationId String
  isArchived     Boolean         @default(false)
  createdAt      DateTime        @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  participants   DMParticipant[]
  messages       DMMessage[]

  @@index([organizationId])
}

model DMParticipant {
  id          String    @id @default(cuid())
  sessionId   String
  userId      String
  lastReadAt  DateTime  @default(now()) // New: Unread tracking
  notificationPreference NotificationPreference @default(ALL)
  
  session     DMSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  isStarred   Boolean   @default(false)

  @@unique([sessionId, userId])
}

model DMMessage {
  id        String   @id @default(cuid())
  content   String
  sessionId String
  senderId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isEdited  Boolean  @default(false)
  isPinned  Boolean  @default(false)

  // Threading
  threadId    String?
  parent      DMMessage?  @relation("DMThread", fields: [threadId], references: [id])
  replies     DMMessage[] @relation("DMThread")
  replyCount  Int       @default(0)

  session   DMSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sender    User      @relation("Sender", fields: [senderId], references: [id])

  // Reactions and mentions
  reactions   DMReaction[]
  mentions    DMMention[]
  attachments DMAttachment[]
  bookmarks   Bookmark[]

  @@index([sessionId, createdAt])
  @@index([threadId])
}

model RegistrationLink {
  id             String   @id @default(cuid())
  organizationId String
  token          String   @unique
  isUsed         Boolean  @default(false)
  usageLimit     Int?
  usageCount     Int      @default(0)
  expiresAt      DateTime?
  createdAt      DateTime @default(now())
  createdBy      String
  creator        User     @relation(fields: [createdBy], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// --- Reactions ---

model Reaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model DMReaction {
  id          String    @id @default(cuid())
  dmMessageId String
  userId      String
  emoji       String
  createdAt   DateTime  @default(now())

  dmMessage   DMMessage @relation(fields: [dmMessageId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dmMessageId, userId, emoji])
  @@index([dmMessageId])
}

// --- Mentions ---

model Mention {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model DMMention {
  id          String    @id @default(cuid())
  dmMessageId String
  userId      String
  createdAt   DateTime  @default(now())

  dmMessage   DMMessage @relation(fields: [dmMessageId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dmMessageId, userId])
  @@index([dmMessageId])
  @@index([userId])
}

// --- Custom Emoji ---

model CustomEmoji {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  imageUrl       String
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
}

// --- Bookmarks ---

model Bookmark {
  id          String   @id @default(cuid())
  userId      String
  messageId   String?
  dmMessageId String?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message     Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  dmMessage   DMMessage? @relation(fields: [dmMessageId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId])
  @@unique([userId, dmMessageId])
  @@index([userId])
  @@index([messageId])
  @@index([dmMessageId])
}

// --- Attachments ---

model Attachment {
  id        String   @id @default(cuid())
  messageId String
  filename  String
  mimetype  String
  size      Int
  url       String
  uploadId  String?
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  upload    Upload?  @relation(fields: [uploadId], references: [id], onDelete: SetNull)

  @@index([messageId])
}

model DMAttachment {
  id          String   @id @default(cuid())
  dmMessageId String
  filename    String
  mimetype    String
  size        Int
  url         String
  uploadId    String?
  createdAt   DateTime @default(now())

  dmMessage   DMMessage @relation(fields: [dmMessageId], references: [id], onDelete: Cascade)
  upload      Upload?    @relation(fields: [uploadId], references: [id], onDelete: SetNull)

  @@index([dmMessageId])
}

model Upload {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  storageKey     String
  url            String
  filename       String
  mimetype       String
  size           Int
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  attachments  Attachment[]
  dmAttachments DMAttachment[]

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
}

enum NotificationPreference {
  ALL
  MENTIONS
  MUTE
}
